<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG Clown - A Jornada do Riso</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#222">
    <style>
        /* --- ESTILO PIXEL ART & UI --- */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            background-color: #111;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            color: white;
            touch-action: none; /* Previne zoom no celular */
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            image-rendering: pixelated; /* Mantém o pixel art nítido */
            border: 2px solid #444;
            background-color: #000;
        }

        /* UI Overlays */
        .ui-layer {
            position: absolute;
            pointer-events: none; /* Deixa clicar no canvas */
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            box-sizing: border-box;
        }

        .hud {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            text-shadow: 1px 1px 0 #000;
        }

        /* Painel de Combate */
        #combat-screen {
            display: none;
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            pointer-events: auto;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .combat-sprite {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            transition: transform 0.2s;
        }

        /* Animações de Combate */
        .shake { animation: shake 0.5s; }
        .attack-anim { animation: lunge 0.2s forwards; }
        .damage-text { color: red; font-size: 20px; position: absolute; animation: floatUp 1s forwards; }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            50% { transform: translate(-3px, 0px) rotate(1deg); }
            100% { transform: translate(1px, -1px) rotate(0deg); }
        }
        @keyframes lunge { 0% { transform: scale(1); } 50% { transform: scale(1.5); } 100% { transform: scale(1); } }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-30px); } }

        .btn {
            background: #333;
            border: 2px solid #fff;
            color: #fff;
            padding: 10px;
            font-family: inherit;
            cursor: pointer;
            margin: 5px;
        }
        .btn:active { background: #555; }

        /* Dialog Box */
        #dialog-box {
            display: none;
            position: absolute;
            bottom: 20px;
            left: 5%;
            width: 90%;
            background: #fff;
            color: #000;
            border: 4px solid #f00;
            padding: 10px;
            font-size: 12px;
            pointer-events: auto;
        }
        
        /* Controles Móveis */
        #mobile-controls {
            display: none; /* Ativado via JS se for mobile */
            position: absolute;
            bottom: 20px;
            right: 20px;
            pointer-events: auto;
        }
        .d-pad-btn {
            width: 50px; height: 50px;
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            font-size: 20px;
        }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div class="ui-layer">
        <div class="hud">
            <span id="player-stats">LVL: 1 | HP: 100/100 | XP: 0</span>
            <span id="weapon-display">Arma: Nariz de Espuma</span>
        </div>
        <div id="toast-msg" style="align-self: center; color: yellow; opacity: 0; transition: opacity 1s;">Jogo Salvo!</div>
    </div>

    <div id="combat-screen">
        <h2 style="color:red">BATALHA!</h2>
        <div id="enemy-display" style="text-align: center;">
            <div id="enemy-sprite" class="combat-sprite" style="background: red;"></div> <p id="enemy-name">Mímico Triste</p>
            <div style="width: 100px; height: 10px; background: #333; margin: 0 auto;">
                <div id="enemy-hp-bar" style="width: 100%; height: 100%; background: red;"></div>
            </div>
        </div>
        <div id="combat-log" style="margin: 20px; font-size: 10px; height: 40px; color: #aaa;"></div>
        <div id="combat-actions">
            <button class="btn" onclick="Game.combat.playerAttack()">Atacar</button>
            <button class="btn" onclick="Game.combat.useItem()">Curar (Poção)</button>
            <button class="btn" onclick="Game.combat.flee()">Fugir</button>
        </div>
    </div>

    <div id="dialog-box" onclick="this.style.display='none'">
        <p id="dialog-text">Olá, palhaço!</p>
        <small>(Toque para fechar)</small>
    </div>

    <div id="mobile-controls">
        <div style="display:flex; justify-content:center;"><button class="d-pad-btn" onclick="Game.input.handle('ArrowUp')">▲</button></div>
        <div style="display:flex; gap:50px">
            <button class="d-pad-btn" onclick="Game.input.handle('ArrowLeft')">◀</button>
            <button class="d-pad-btn" onclick="Game.input.handle('ArrowRight')">▶</button>
        </div>
        <div style="display:flex; justify-content:center;"><button class="d-pad-btn" onclick="Game.input.handle('ArrowDown')">▼</button></div>
    </div>
</div>

<script>
/**
 * RPG CLOWN - ENGINE
 * Autor: Gemini AI
 */

const CONSTANTS = {
    TILE_SIZE: 32,
    VIEW_WIDTH: 15, // Tiles visíveis horizontalmente
    VIEW_HEIGHT: 11, // Tiles visíveis verticalmente
    FOG_RADIUS: 5
};

// --- SISTEMA DE DADOS (ITEMS, INIMIGOS) ---
const ITEMS = {
    weapon1: { name: "Nariz de Espuma", dmg: 5, type: 'weapon' },
    weapon2: { name: "Marreta de Borracha", dmg: 12, type: 'weapon' },
    armor1:  { name: "Sapatos Gigantes", def: 2, type: 'armor' },
    potion:  { name: "Torta de Creme", heal: 30, type: 'consumable' }
};

const ENEMIES = {
    slime: { name: "Mímico Triste", hp: 30, maxHp: 30, atk: 4, xp: 10, color: '#888' },
    skeleton: { name: "Esqueleto Malabarista", hp: 60, maxHp: 60, atk: 8, xp: 25, color: '#eee' },
    boss: { name: "O Grande Depresso", hp: 200, maxHp: 200, atk: 15, xp: 500, color: '#505', isBoss: true }
};

// --- ESTADO DO JOGO & SAVE SYSTEM ---
const GameState = {
    player: {
        x: 2, y: 2,
        level: 1, xp: 0, nextLevelXp: 50,
        hp: 100, maxHp: 100,
        atk: 5, def: 0,
        inventory: ['potion', 'potion'],
        equipment: { weapon: 'weapon1', armor: 'armor1' },
        quests: { defeatedBoss: false }
    },
    map: [], // Será gerado
    mode: 'EXPLORE', // EXPLORE, COMBAT, DIALOG
    width: 50,
    height: 50,
    
    save: function() {
        localStorage.setItem('rpgClownSave', JSON.stringify(this.player));
        const toast = document.getElementById('toast-msg');
        toast.style.opacity = 1;
        setTimeout(() => toast.style.opacity = 0, 2000);
    },
    load: function() {
        const data = localStorage.getItem('rpgClownSave');
        if(data) this.player = JSON.parse(data);
    }
